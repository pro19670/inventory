<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>인증 디버깅</title>
</head>
<body>
    <h1>🔍 인증 시스템 디버깅</h1>
    
    <div>
        <h3>1. 현재 저장소 상태</h3>
        <button onclick="checkStorage()">저장소 확인</button>
        <pre id="storageStatus"></pre>
    </div>
    
    <div>
        <h3>2. 토큰 설정 테스트</h3>
        <button onclick="setTestToken()">관리자 토큰 설정</button>
        <button onclick="clearTokens()">토큰 제거</button>
    </div>
    
    <div>
        <h3>3. API 테스트</h3>
        <button onclick="testLoginAPI()">로그인 API 테스트</button>
        <button onclick="testVerifyAPI()">토큰 검증 API 테스트</button>
        <pre id="apiResults"></pre>
    </div>
    
    <div>
        <h3>4. 페이지 이동</h3>
        <button onclick="goToMain()">메인 페이지로 이동</button>
        <button onclick="goToLogin()">로그인 페이지로 이동</button>
    </div>

    <script>
        // API URL 설정 (메인 페이지와 동일)
        var API_BASE = (function() {
            var hostname = window.location.hostname;
            
            if (hostname.includes('e2b.dev')) {
                return 'https://3001-i72krmbsmpnff1c7v14w6-6532622b.e2b.dev';
            }
            
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return 'http://localhost:3001';
            }
            
            return 'https://inventory.onrender.com';
        })();
        
        function checkStorage() {
            const familyToken = localStorage.getItem('familyAuthToken');
            const currentUser = localStorage.getItem('currentUser');
            const allKeys = Object.keys(localStorage);
            
            const status = `
🔍 저장소 상태:
- familyAuthToken: ${familyToken ? '✅ 있음 (' + familyToken.substring(0, 30) + '...)' : '❌ 없음'}
- currentUser: ${currentUser ? '✅ 있음 (' + currentUser.substring(0, 50) + '...)' : '❌ 없음'}
- 전체 키: [${allKeys.join(', ')}]

📊 상세 정보:
- Token 길이: ${familyToken ? familyToken.length : 0}
- User JSON 길이: ${currentUser ? currentUser.length : 0}
            `;
            
            document.getElementById('storageStatus').textContent = status;
            console.log('Storage 상태:', {familyToken: !!familyToken, currentUser: !!currentUser, allKeys});
        }
        
        function setTestToken() {
            const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJ1c2VyX2FkbWluIiwiZmFtaWx5SWQiOiJmYW1pbHlfZGVtbyIsInJvbGUiOiJhZG1pbiIsInVzZXJuYW1lIjoi6rSA66as7J6QIiwiaWF0IjoxNzU1NDAzMDI1LCJleHAiOjE3NTYwMDc4MjV9.BwEjnykt2faV76Ji2hALX_-DKirOkT8UbU2nxBdmqvM";
            const user = {
                "id": "user_admin",
                "username": "관리자",
                "role": "admin",
                "avatar": "👨‍💼",
                "familyId": "family_demo",
                "permissions": ["*"]
            };
            
            console.log('🔧 테스트 토큰 설정 중...');
            localStorage.setItem('familyAuthToken', token);
            localStorage.setItem('currentUser', JSON.stringify(user));
            
            console.log('✅ 토큰 설정 완료');
            console.log('Token:', token.substring(0, 30) + '...');
            console.log('User:', user);
            
            checkStorage();
        }
        
        function clearTokens() {
            console.log('🗑️ 토큰 제거 중...');
            localStorage.removeItem('familyAuthToken');
            localStorage.removeItem('currentUser');
            console.log('✅ 토큰 제거 완료');
            
            checkStorage();
        }
        
        async function testLoginAPI() {
            console.log('🔐 로그인 API 테스트 시작...');
            document.getElementById('apiResults').textContent = '로그인 API 호출 중...';
            
            try {
                const response = await fetch(`${API_BASE}/api/family-auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: '관리자',
                        password: 'admin123'
                    })
                });
                
                const data = await response.json();
                console.log('로그인 API 응답:', data);
                
                if (data.success) {
                    document.getElementById('apiResults').textContent = `
✅ 로그인 API 성공!
- 사용자: ${data.user.username}
- 역할: ${data.user.role}
- 토큰: ${data.token.substring(0, 30)}...
                    `;
                    
                    // 토큰 자동 저장
                    localStorage.setItem('familyAuthToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    
                    checkStorage();
                } else {
                    document.getElementById('apiResults').textContent = `❌ 로그인 실패: ${data.error}`;
                }
            } catch (error) {
                console.error('로그인 API 오류:', error);
                document.getElementById('apiResults').textContent = `❌ API 오류: ${error.message}`;
            }
        }
        
        async function testVerifyAPI() {
            const token = localStorage.getItem('familyAuthToken');
            
            if (!token) {
                document.getElementById('apiResults').textContent = '❌ 토큰이 없습니다. 먼저 로그인하거나 테스트 토큰을 설정하세요.';
                return;
            }
            
            console.log('🔍 토큰 검증 API 테스트 시작...');
            document.getElementById('apiResults').textContent = '토큰 검증 API 호출 중...';
            
            try {
                const response = await fetch(`${API_BASE}/api/family-auth/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                console.log('토큰 검증 API 응답:', data);
                
                if (data.success) {
                    document.getElementById('apiResults').textContent = `
✅ 토큰 검증 성공!
- 사용자: ${data.user.username}
- 역할: ${data.user.role}
- 권한: ${data.user.permissions.join(', ')}
                    `;
                } else {
                    document.getElementById('apiResults').textContent = `❌ 토큰 검증 실패: ${data.error || '알 수 없는 오류'}`;
                }
            } catch (error) {
                console.error('토큰 검증 API 오류:', error);
                document.getElementById('apiResults').textContent = `❌ API 오류: ${error.message}`;
            }
        }
        
        function goToMain() {
            console.log('📱 메인 페이지로 이동...');
            window.location.href = '/';
        }
        
        function goToLogin() {
            console.log('🔐 로그인 페이지로 이동...');
            window.location.href = '/login.html';
        }
        
        // 페이지 로드 시 자동으로 저장소 상태 확인
        window.addEventListener('load', () => {
            console.log('🔍 디버깅 페이지 로드됨');
            checkStorage();
        });
    </script>
</body>
</html>